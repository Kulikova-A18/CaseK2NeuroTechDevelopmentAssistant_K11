# ⭐ ЧАСТЬ 1 — МОДУЛИ И ИХ ФУНКЦИИ (КРАТКОЕ ОПИСАНИЕ)

## **1. agent_core.py**
Главный роутер, вызываемый backend.

**Функции:**
- `agent_process(payload)`  
  Определяет режим (initial / clarification) и вызывает нужный handler.  
  Оборачивает ответ в `{ type: "json" | "text", data: ... }`.

---

## **2. daily.py**
Отвечает за обработку ответов daily.

**Функции:**
- `handle_initial(payload)`  
  Обрабатывает первое сообщение пользователя.  
  Строит prompt → вызывает LLM → получает JSON →  
  сверяет данные с задачами трекера →  
  решает, нужно ли уточнение.

- `handle_clarification(payload)`  
  Обрабатывает ответ пользователя на уточняющий вопрос.  
  Строит новый prompt на основе предыдущего JSON и ответа пользователя →  
  вызывает LLM → получает финальный JSON →  
  повторно сверяет с трекером.

**Вспомогательная логика daily:**
- `compare_with_tracker(model_json, tasks_from_tracker)`
Это ключевая функция валидации, обеспечивающая корректность работы ассистента.

Она проверяет:

- **валидность task_id**  
  (все ли упомянутые моделью задачи реально существуют у пользователя)

- **упоминание несуществующих задач**  
  (модель не имеет права создавать новые задачи — если это произошло → требуется уточнение)

- **статусные расхождения**  
  (например, пользователь говорит “делаю UI-102”, а в трекере UI-102 уже Done)

- **соответствие структуры и логики**  
  (корректно ли распределены yesterday / today)

Формирует:
- `status_mismatches` — список выявленных несостыковок.

На основе результата daily принимает решение:
- можно ли принять JSON как валидный,
- либо необходимо задать пользователю уточняющий вопрос.
  Проверяет:
  - валидность task_id,
  - расхождения статусов,
  - упоминание несуществующих задач,
  - формирует `status_mismatches`.

---

## **3. blockers.py**
Работает *только* с блокерами, выделенными моделью.

**Функции:**
- `process(blockers, tasks_from_tracker)`  
  - нормализация описаний блокеров,  
  - проверка соответствия реальным задачам,  
  - определение severity,  
  - формирование эскалации.

---

## **4. utils/builders.py**
Строит prompts.

**Функции:**
- `build_daily_initial_prompt(context)`  
- `build_daily_clarification_prompt(context)`

Prompt включает:
- системные правила,
- список задач пользователя,
- предыдущие daily,
- сырое сообщение пользователя,
- требования к JSON.

---

## **5. utils/llm_json.py**
- `call_llm_json(system_prompt, user_prompt)`  
Вызывает LLM и парсит JSON-ответ.

---

## **6. backend**
Внешний слой, который предоставляет данные и принимает результаты.

**Отвечает за:**
- получение сообщений пользователей,
- загрузку задач из трекера,
- передачу контекста в LLM,
- сохранение результатов daily,
- обработку эскалаций.

---

# ⭐ ЧАСТЬ 2 — ПОЛНАЯ СХЕМА DAILY (INITIAL + УТОЧНЕНИЕ + СВЕРКА С ТРЕКЕРОМ + BLOCKERS)

                 ┌──────────────────────────────────┐                                   ← Пользователь вводит daily
                │ 1. Пользователь пишет daily-ответ│
                │    (сырой текст)                 │
                └───────────────┬──────────────────┘
                                ▼
                ┌──────────────────────────────────┐                                   ← Backend собирает контекст
                │ 2. Backend получает сообщение     │
                │    и собирает КОНТЕКСТ:           │
                │    • user info                    │
                │    • задачи из трекера            │
                │    • previous_daily_json          │
                │    • raw_daily_answer             │
                └───────────────┬──────────────────┘
                                ▼
                ┌──────────────────────────────────┐                                   ← Backend вызывает агент
                │ 3. Backend вызывает              │
                │    agent_process(mode="initial") │
                └───────────────┬──────────────────┘
                                ▼
    ┌────────────────────────────────────────────────────────┐                           ← agent_core → daily.handle_initial
    │ 4. agent_core → daily.handle_initial(payload)          │
    └───────────────┬────────────────────────────────────────┘
                    ▼
    ┌────────────────────────────────────────────────────────┐                           ← Формирование LLM prompt
    │ 5. build_daily_initial_prompt(context):                 │
    │    PROMPT =                                            │
    │    [SYSTEM] +                                          │
    │    [TASK TRACKER CONTEXT] +                            │  ← модель видит задачи
    │    [PREVIOUS DAILY] +                                  │
    │    [RAW USER TEXT] +                                   │
    │    [JSON SCHEMA RULES]                                 │
    └───────────────┬────────────────────────────────────────┘
                    ▼
    ┌────────────────────────────────────────────────────────┐                           ← Модель возвращает JSON
    │ 6. call_llm_json(prompt)                               │
    │    → модель возвращает JSON:                           │
    │      {                                                 │
    │        yesterday: [...],                               │
    │        today: [...],                                   │
    │        blockers: [...],                                │
    │        needs_clarification: bool,                      │
    │        clarification_questions: [...]                  │
    │      }                                                 │
    └───────────────┬────────────────────────────────────────┘
                    ▼
    ┌────────────────────────────────────────────────────────┐                           ← Сверка JSON с трекером
    │ 7. DAILY сверяет JSON с задачами из трекера:           │
    │      compare_with_tracker()                            │  ← ловим ошибки модели
    │    • валидность task_id                                │
    │    • статусные несостыковки                            │
    │    • задачи, которых нет у пользователя                │
    │    → добавляет status_mismatches в JSON                │
    └───────────────┬────────────────────────────────────────┘
                    ▼
    ┌────────────────────────────────────────────────────────┐                           ← Нужно ли уточнение?
    │ 8. DAILY: нужно ли уточнение?                          │
    │    if needs_clarification OR status_mismatch:          │  ← если недостаточно данных
    │         вернуть текстовые вопросы                      │
    │    else → идём дальше                                  │
    └───────────────┬────────────────────────────────────────┘
                    │
                    │ Да → Уточнение                                                       ← Уточнение от пользователя
                    ▼
        ┌──────────────────────────────────────────────┐                                   ← Агент возвращает текст вопроса
        │ 9. agent_core возвращает                      │
        │    { type: "text", data: clarification_q }    │
        └───────────────┬──────────────────────────────┘
                        ▼
        ┌──────────────────────────────────────────────┐                                   ← Backend задаёт вопрос пользователю
        │ 10. Backend задаёт уточняющий вопрос         │
        │     пользователю                             │
        └───────────────┬──────────────────────────────┘
                        ▼
        ┌──────────────────────────────────────────────┐                                   ← Пользователь пишет уточнение
        │ 11. Пользователь пишет уточнение             │
        └───────────────┬──────────────────────────────┘
                        ▼
        ┌──────────────────────────────────────────────┐                                   ← Второй проход: clarification
        │ 12. Backend вызывает                         │
        │      agent_process(mode="clarification")     │
        └───────────────┬──────────────────────────────┘
                        ▼
    ┌────────────────────────────────────────────────────────┐                           ← Формируется новый prompt (с историей диалога)
    │ 13. daily.handle_clarification(payload):               │
    │     PROMPT =                                           │
    │     [SYSTEM] +                                         │
    │     [TASK TRACKER CONTEXT] +                           │  ← задачи снова доступны модели
    │     [ПРЕДЫДУЩИЙ JSON DAILY] +                          │  ← модель видит, что уже было разобрано
    │     [USER CLARIFICATION TEXT] +                        │  ← + текущий ответ пользователя
    │     [DIALOG CONTEXT (Q/A В РАМКАХ ЭТОГО DAILY)]        │  ← модель видит предыдущий диалог по этому daily
    │     [JSON SCHEMA RULES]                                │
    └───────────────┬────────────────────────────────────────┘
                    ▼
    ┌────────────────────────────────────────────────────────┐                           ← Финальная JSON-структура
    │ 14. call_llm_json → ФИНАЛЬНЫЙ DAILY JSON               │
    └───────────────┬────────────────────────────────────────┘
                    ▼
    ┌────────────────────────────────────────────────────────┐                           ← Повторная сверка с трекером
    │ 15. daily.compare_with_tracker() (повторная сверка)    │
    └───────────────┬────────────────────────────────────────┘
                    ▼
    ┌────────────────────────────────────────────────────────┐                           ← Передаём блокеры в анализ
    │ 16. agent_core вызывает blockers.process()             │
    │     (только для поля blockers из JSON)                 │
    └───────────────┬────────────────────────────────────────┘
                    ▼
    ┌────────────────────────────────────────────────────────┐                           ← Определяем severity
    │ 17. blockers.process():                                │
    │    • нормализация                                      │
    │    • сверка с трекером                                 │
    │    • severity                                           │
    │    • решение об эскалации                              │
    └───────────────┬────────────────────────────────────────┘
                    ▼
       ┌───────────────────────────┐                                           ← Критичный блокер?
       │ 18. Есть критичный блокер?│
       └───────────┬──────────────┘
                   │ Yes
                   ▼
       ┌───────────────────────────┐                                           ← Эскалация тимлиду
       │ 19. agent_core → backend  │
       │     escalation_payload     │
       └───────────────────────────┘

                   │ No
                   ▼
    ┌────────────────────────────────────────────────────────┐                        ← Финальное сохранение
    │ 20. Backend сохраняет всё:                             │
    │     • финальный JSON daily                             │
    │     • блокеры и их severity                            │
    │     • несостыковки состояний                           │
    │     • эскалации (если были)                            │
    └────────────────────────────────────────────────────────┘

